<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Chat</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">
    <!--<script src="chat.js"></script>-->
  </head>
  <body>
    <div class="waveWrapper waveAnimation">
      <div class="waveWrapperInner bgTop">
        <div class="wave waveTop" style="background-image: url('http://front-end-noobs.com/jecko/img/wave-top.png')"></div>
      </div>
      <div class="waveWrapperInner bgMiddle">
        <div class="wave waveMiddle" style="background-image: url('http://front-end-noobs.com/jecko/img/wave-mid.png')"></div>
      </div>
      <div class="waveWrapperInner bgBottom">
        <div class="wave waveBottom" style="background-image: url('http://front-end-noobs.com/jecko/img/wave-bot.png')"></div>
      </div>
    </div>

    <div class="popup" id="nameup">
      <input type="text" id="tname" placeholder="–í—Å–µ–≤–æ–ª–æ–¥" maxlength="15" minlength="3">
      <button id="username" onclick="userbtn()">–ó–∞–ø–æ–º–Ω–∏—Ç—å</button>
    </div>

    <div class="container">
      <div class="top"></div>
      <div class="chat" id="box">
        <div id="txtn" class="bubble"></div>
      </div>
      <div class="write">
          <a href="javascript:void(2020);" class="write-link attach" onclick="alert('–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')"></a>
          <input type="text" id="msginput">
          <a href="javascript:void(2020);" class="write-link send" onclick="requp()"></a>
          <a href="javascript:void(2020);" class="write-link smiley" onclick="alert('–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')"></a>
      </div>
    </div>
    <script>
      const request = require('request');
      function popup () {
        nameup.style.display = "block";
      }
      function userbtn () {
        if (tname.value.length >= 3 && tname.value.length <= 15) {
          nameup.style.display = "none";
          localStorage.setItem('name', tname.value);
        } else {
          alert('–ü–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –Ω–µ–≤–µ—Ä–Ω–æ, –∏–ª–∏ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ!');
        }
      }
      // —Å—Ç–∞—Ä—Ç, –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
      function reqstart () {
        request('https://chatapi2.herokuapp.com/1', function (error, response, body) {
          //console.clear();
          console.log('statusCode:', response && response.statusCode);
          // —Ç–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã
          //error = 5;
          //response.statusCode = 404;
          if (response.statusCode == 200 && error == null) {
            reqread();
          } else {
            alert('–û —á—ë—Ä—Ç... –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫!');
          }
        });
        let test = localStorage.getItem('name');
        if (test == null) {
          popup();
        } else {
          console.log('üëç');
        }
      }
      // —á—Ç–µ–Ω–∏–µ
      function reqread () {
        request('https://chatapi2.herokuapp.com/1/read', function (error, response, body) {
          //console.clear();
          console.log('error:', error);
          console.log('statusCode:', response && response.statusCode);
          //if (txtn) {
          //  txtn.remove();
          //}
          while (box.firstChild) {
            box.removeChild(box.lastChild);
          }
          // –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
          body = body.replace(/\n/g, '</div><div id="txtn" class="bubble">');
          body = body.replace(/;/g, ' : ');
          chatup(body);
        });
        setTimeout(reqread, 500);
      }
      // –æ—Ç–ø—Ä–∞–≤–∫–∞
      function requp () {
        let user = encodeURIComponent(localStorage.getItem('name'));
        let msg = encodeURIComponent(msginput.value);
        msg = msg.replace(/ /g, '%20');
        request('https://chatapi2.herokuapp.com/1/write/' + user + '/' + msg, function (error, response, body) {
          //console.clear();
          console.log('error:', error);
        });
        msginput.value = "";
      }
      // –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
      function chatup (msg) {
        var upmsg = '<div id="txtn" class="bubble">' + msg + "</div>";
        box.insertAdjacentHTML("beforeend", upmsg);
      }
      //start
      reqstart();
    </script>
  </body>
</html>
